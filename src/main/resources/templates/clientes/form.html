<!DOCTYPE html>
<html lang="pt-BR" th:replace="~{layout/base :: layout(
    pageTitle=${modoEdicao ? 'Editar Cliente B2B' : 'Novo Cliente B2B'},
    activePage='clientes',
    content=~{::main},
    extraHead=~{},
    extraScript=~{::script}
)}">
<main>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/web/clientes">Clientes B2B</a></li>
            <li class="breadcrumb-item active" th:text="${modoEdicao ? 'Editar' : 'Novo Cliente'}">Novo</li>
        </ol>
    </nav>

    <form th:action="@{/web/clientes/salvar}" method="post" th:object="${cliente}">
        <input type="hidden" th:field="*{id}">
        <div class="row g-3">
            <div class="col-md-8">
                <!-- DADOS DA EMPRESA -->
                <div class="card mb-3">
                    <div class="card-header"><span style="font-weight:600;font-size:.9rem"><i
                                class="fas fa-building me-2 text-primary"></i>Dados da Empresa</span></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Razão Social <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{razaoSocial}"
                                    placeholder="Razão Social completa" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nome Fantasia</label>
                                <input type="text" class="form-control" th:field="*{nomeFantasia}"
                                    placeholder="Nome comercial">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">CNPJ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{cnpj}" id="cnpj"
                                    placeholder="00.000.000/0000-00" maxlength="18">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Inscrição Estadual</label>
                                <input type="text" class="form-control" th:field="*{inscricaoEstadual}"
                                    placeholder="Ex: 123.456.789.000">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contato / Responsável</label>
                                <input type="text" class="form-control" th:field="*{contato}"
                                    placeholder="Nome do comprador">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Telefone</label>
                                <input type="text" class="form-control" th:field="*{telefone}" id="telefone"
                                    placeholder="(00) 00000-0000">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">E-mail</label>
                                <input type="email" class="form-control" th:field="*{email}"
                                    placeholder="pedidos@empresa.com.br">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ENDEREÇO -->
                <div class="card">
                    <div class="card-header"><span style="font-weight:600;font-size:.9rem"><i
                                class="fas fa-map-marker-alt me-2 text-success"></i>Endereço de Entrega / Fiscal</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">CEP</label>
                                <input type="text" class="form-control" th:field="*{cep}" id="cep"
                                    placeholder="00000-000" maxlength="9">
                            </div>
                            <div class="col-md-9">
                                <label class="form-label">Logradouro</label>
                                <input type="text" class="form-control" th:field="*{endereco}"
                                    placeholder="Rua, Avenida, etc.">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Número</label>
                                <input type="text" class="form-control" th:field="*{numero}" placeholder="N°">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Complemento</label>
                                <input type="text" class="form-control" th:field="*{complemento}"
                                    placeholder="Sala, Andar...">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Bairro</label>
                                <input type="text" class="form-control" th:field="*{bairro}" placeholder="Bairro">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cidade</label>
                                <input type="text" class="form-control" th:field="*{cidade}" placeholder="Cidade">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" th:field="*{estado}">
                                    <option value="">UF</option>
                                    <option
                                        th:each="uf : ${ {'AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'} }"
                                        th:value="${uf}" th:text="${uf}">UF</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LATERAL COMERCIAL -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header"><span style="font-weight:600;font-size:.9rem"><i class="fas fa-tag me-2"
                                style="color:#7e22ce"></i>Configuração Comercial</span></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Perfil de Preço</label>
                            <select class="form-select" th:field="*{perfilPreco}">
                                <option value="VAREJO">Varejo</option>
                                <option value="ATACADO">Atacado</option>
                                <option value="DISTRIBUIDOR">Distribuidor</option>
                            </select>
                            <small class="text-muted">O preço aplicado nos pedidos seguirá este perfil</small>
                        </div>
                        <div class="mb-0">
                            <label class="form-label">Limite de Crédito (R$)</label>
                            <div class="input-group">
                                <span class="input-group-text" style="font-size:.8rem">R$</span>
                                <input type="number" class="form-control" th:field="*{limiteCredito}" step="0.01"
                                    min="0" placeholder="0,00">
                            </div>
                            <small class="text-muted">0 = sem limite</small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-floppy-disk me-2"></i>
                                <span th:text="${modoEdicao ? 'Salvar Alterações' : 'Cadastrar Cliente'}">Salvar</span>
                            </button>
                            <a href="/web/clientes" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i> Voltar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</main>
<script>
    document.getElementById('cnpj')?.addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '').slice(0, 14);
        if (v.length > 12) v = v.slice(0, 2) + '.' + v.slice(2, 5) + '.' + v.slice(5, 8) + '/' + v.slice(8, 12) + '-' + v.slice(12);
        else if (v.length > 8) v = v.slice(0, 2) + '.' + v.slice(2, 5) + '.' + v.slice(5, 8) + '/' + v.slice(8);
        else if (v.length > 5) v = v.slice(0, 2) + '.' + v.slice(2, 5) + '.' + v.slice(5);
        else if (v.length > 2) v = v.slice(0, 2) + '.' + v.slice(2);
        this.value = v;
    });
    document.getElementById('telefone')?.addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '').slice(0, 11);
        if (v.length > 6) v = '(' + v.slice(0, 2) + ') ' + v.slice(2, 7) + '-' + v.slice(7);
        else if (v.length > 2) v = '(' + v.slice(0, 2) + ') ' + v.slice(2);
        this.value = v;
    });
    // Buscar CNPJ via BrasilAPI
    document.getElementById('cnpj')?.addEventListener('blur', function () {
        const cnpj = this.value.replace(/\D/g, '');
        if (cnpj.length === 14) {
            const btnSalvar = document.querySelector('button[type="submit"]');
            const originalBtnHtml = btnSalvar.innerHTML;
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando CNPJ...';

            fetch('https://brasilapi.com.br/api/cnpj/v1/' + cnpj)
                .then(r => r.json())
                .then(d => {
                    if (d.razao_social) {
                        document.querySelector('[name="razaoSocial"]').value = d.razao_social || '';
                        document.querySelector('[name="nomeFantasia"]').value = d.nome_fantasia || '';
                        document.querySelector('[name="cep"]').value = d.cep ? d.cep.replace(/^(\d{5})(\d{3})$/, "$1-$2") : '';
                        document.querySelector('[name="endereco"]').value = d.logradouro || '';
                        document.querySelector('[name="numero"]').value = d.numero || '';
                        document.querySelector('[name="complemento"]').value = d.complemento || '';
                        document.querySelector('[name="bairro"]').value = d.bairro || '';
                        document.querySelector('[name="cidade"]').value = d.municipio || '';
                        document.querySelector('[name="estado"]').value = d.uf || '';
                        document.querySelector('[name="telefone"]').value = d.ddd_telefone_1 || '';

                        // Formatar o telefone retornado
                        let telEvent = new Event('input');
                        let telInput = document.querySelector('[name="telefone"]');
                        if (telInput) {
                            telInput.dispatchEvent(telEvent);
                        }
                    }
                })
                .catch(e => console.error("Erro ao buscar CNPJ:", e))
                .finally(() => {
                    btnSalvar.disabled = false;
                    btnSalvar.innerHTML = originalBtnHtml;
                });
        }
    });

    // Máscara CEP e Busca ViaCEP
    document.getElementById('cep')?.addEventListener('blur', function () {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch('https://viacep.com.br/ws/' + cep + '/json/')
                .then(r => r.json()).then(d => {
                    if (!d.erro) {
                        document.querySelector('[name="endereco"]').value = d.logradouro || '';
                        document.querySelector('[name="bairro"]').value = d.bairro || '';
                        document.querySelector('[name="cidade"]').value = d.localidade || '';
                        document.querySelector('[name="estado"]').value = d.uf || '';
                    }
                }).catch(() => { });
        }
    });
    document.getElementById('cep')?.addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '').slice(0, 8);
        if (v.length > 5) v = v.slice(0, 5) + '-' + v.slice(5);
        this.value = v;
    });
</script>

</html>